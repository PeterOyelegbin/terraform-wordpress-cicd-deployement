name: Deploy to Staging and Production

on:
  push:
    branches: [ dev, main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - branch: dev
            environment: staging
            server-host: ${{ secrets.STAGING_IP }}
            server-username: ${{ secrets.SERVER_USER }}
            server-ssh-key: ${{ secrets.SSH_PUBLIC_KEY }}
            webhook-url: ${{ secrets.STAGING_SLACK_WEBHOOK_URL }}
          - branch: main
            environment: production
            server-host: ${{ secrets.PROD_IP }}
            server-username: ${{ secrets.SERVER_USER }}
            server-ssh-key: ${{ secrets.SSH_PUBLIC_KEY }}
            webhook-url: ${{ secrets.PRODUCTION_SLACK_WEBHOOK_URL }}
    
    environment: ${{ matrix.environment }}
    
    # Only run for the specific branch that triggered the workflow
    if: github.ref == 'refs/heads/${{ matrix.branch }}'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Detect environment and branch
      run: |
        echo "üéØ Deployment Target: ${{ matrix.environment }}"
        echo "üåø Branch: ${{ github.ref }}"
        echo "üè∑Ô∏è  Git SHA: ${{ github.sha }}"

    - name: Deploy to ${{ matrix.environment }}
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ matrix.server-host }}
        username: ${{ matrix.server-username }}
        key: ${{ matrix.server-ssh-key }}
        script: |
          set -e  # Exit on error
          
          echo "üöÄ Deploying to ${{ matrix.environment }} server..."
          echo "üìù Branch: ${{ github.ref }}"
          echo "üîë Commit: ${{ github.sha }}"
          
          # Install nginx if not present
          apt-get update
          apt-get install -y nginx
          systemctl enable nginx
          systemctl start nginx

          # Create backup with environment and timestamp
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          sudo cp -r /var/www/html /var/www/html.backup.${{ matrix.environment }}.$TIMESTAMP 2>/dev/null || true
          
          # Deploy new files
          sudo rm -rf /var/www/html/*
          sudo mkdir -p /var/www/html
          sudo cp -r frontend/* /var/www/html/
          
          # Set permissions
          sudo chown -R www-data:www-data /var/www/html
          sudo chmod -R 755 /var/www/html
          
          # Create deployment info file
          echo "Environment: ${{ matrix.environment }}" | sudo tee /var/www/html/deployment-info.txt
          echo "Branch: ${{ github.ref }}" | sudo tee -a /var/www/html/deployment-info.txt
          echo "Commit: ${{ github.sha }}" | sudo tee -a /var/www/html/deployment-info.txt
          echo "Deployed at: $(date)" | sudo tee -a /var/www/html/deployment-info.txt
          
          # Test and reload nginx
          sudo nginx -t
          sudo systemctl reload nginx
          
          echo "‚úÖ ${{ matrix.environment }} deployment completed successfully!"
          echo "üìÅ Backup created: /var/www/html.backup.${{ matrix.environment }}.$TIMESTAMP"

    - name: Verify ${{ matrix.environment }} deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ matrix.server-host }}
        username: ${{ matrix.server-username }}
        key: ${{ matrix.server-ssh-key }}
        script: |
          # Verify nginx is running
          if systemctl is-active --quiet nginx; then
            echo "‚úÖ Nginx is running on ${{ matrix.environment }}"
          else
            echo "‚ùå Nginx is not running on ${{ matrix.environment }}"
            exit 1
          fi
          
          # Verify files are deployed
          if [ -n "$(ls -A /var/www/html/)" ]; then
            echo "‚úÖ Files are deployed successfully to ${{ matrix.environment }}"
            echo "üìÑ Deployment info:"
            cat /var/www/html/deployment-info.txt || echo "No deployment info file"
          else
            echo "‚ùå No files found in /var/www/html/ on ${{ matrix.environment }}"
            exit 1
          fi
          
